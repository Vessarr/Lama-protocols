<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE muclient>
<!-- Saved on Tuesday, October 14, 2014, 12:07 PM -->
<!-- MuClient version 4.84 -->
<!-- Plugin "lamamusicprotocol" generated by Plugin Wizard -->
<muclient>
<plugin
   name="lamafileprotocol"
   id="3422fdd9446f4ecaa30671a5"
   language="Lua"
   purpose="data transfer protocol from mud server to client"
   date_written="2014-10-14 12:05:59"
   requires="4.84"
   version="1.0"
   >
</plugin>
<!--  Get our standard constants -->
<include name="constants.lua"/>
<!--  Triggers  -->
<triggers>
  <trigger
   enabled="n"
   group="scan"
   keep_evaluating="y"
   match="(^(.*)$)"
   regexp="y"
   multi_line="n"
   lines_to_match="1"
   omit_from_output="y"
   send_to="12"
   sequence="10"
   script="scan"
  >
  </trigger>
<trigger
   enabled="n"
   group="filestop"
   keep_evaluating="n"
   match="\{\/file\}"
   regexp="y"
   multi_line="n"
   lines_to_match="1"
   omit_from_output="y"
   send_to="12"
   sequence="100"
   script="fileend"
  >
  </trigger>
  <trigger
   enabled="y"
   group="filestart"
   keep_evaluating="n"
   match="\{file\[(.*)\[(.*)\[(.*)\[(.*)\}"
   regexp="y"
   multi_line="n"
   lines_to_match="1"
   omit_from_output="y"
   send_to="12"
   sequence="100"
   script="filestart"
  >
  </trigger>
</triggers>
<script>
data = {}
fl = ""
nm = ""
ext = ""
pl = "n"
currentlyplaying = ""
tmp = 1
tmpw = 1
cc = {}
cc["NUL"] = "000"
cc["SOH"] = "001"
cc["STX"] = "002"
cc["ETX"] = "003"
cc["EOT"] = "004"
cc["ENQ"] = "005"
cc["ACK"] = "006"
cc["BEL"] = "007"
cc["BS"] = "008"
cc["HT"] = "009"
cc["LF"] = "010"
cc["VT"] = "011"
cc["FF"] = "012"
cc["CR"] = "013"
cc["SO2"] = "014"
cc["SI1"] = "015"
cc["DLE"] = "016"
cc["DC1"] = "017"
cc["DC2"] = "018"
cc["DC3"] = "019"
cc["DC4"] = "020"
cc["NAK"] = "021"
cc["SYN"] = "022"
cc["EBT"] = "023"
cc["CAN"] = "024"
cc["EM"] = "025"
cc["SUB"] = "026"
cc["ESC"] = "027"
cc["FS"] = "028"
cc["GS"] = "029"
cc["RS"] = "030"
cc["US"] = "031"
cc["DEL"] = "127"
fc = {}
fc["NBS"] = "160"
fc["IEM"] = "161"
fc["CSN"] = "162"
fc["PSN"] = "163"
fc["CUS"] = "164"
fc["YNS"] = "165"
fc["BRB"] = "166"
fc["SSN"] = "167"
fc["DIA"] = "168"
fc["CPS"] = "169"
fc["FOI"] = "170"
fc["LDQ"] = "171"
fc["NSN"] = "172"
fc["STH"] = "173"
fc["RGS"] = "174"
fc["MAC"] = "175"
fc["DGS"] = "176"
fc["PMS"] = "177"
fc["SS2"] = "178"
fc["SS3"] = "179"
fc["AAC"] = "180"
fc["MCS"] = "181"
fc["PIS"] = "182"
fc["MDD"] = "183"
fc["CID"] = "184"
fc["SS1"] = "185"
fc["MOI"] = "186"
fc["RDQ"] = "187"
fc["FOQ"] = "188"
fc["FOH"] = "189"
fc["FTQ"] = "190"
fc["IQM"] = "191"
fc["AWG"] = "192"
fc["AWA"] = "193"
fc["AWC"] = "194"
fc["AWT"] = "195"
fc["AWD"] = "196"
fc["AWR"] = "197"
fc["CAE"] = "198"
fc["CCD"] = "199"
fc["EWG"] = "200"
fc["EWA"] = "201"
fc["EWC"] = "202"
fc["EWD"] = "203"
fc["IWG"] = "204"
fc["IWA"] = "205"
fc["IWC"] = "206"
fc["IWD"] = "207"
fc["ETH"] = "208"
fc["NWT"] = "209"
fc["OWG"] = "210"
fc["OWA"] = "211"
fc["OWC"] = "212"
fc["OWT"] = "213"
fc["OWD"] = "214"
fc["MPS"] = "215"
fc["OWS"] = "216"
fc["UWG"] = "217"
fc["UWA"] = "218"
fc["UWC"] = "219"
fc["UWD"] = "220"
fc["YWA"] = "221"
fc["THO"] = "222"
fc["SHS"] = "223"
fc["SAG"] = "224"
fc["SAA"] = "225"
fc["SAC"] = "226"
fc["SAT"] = "227"
fc["SAD"] = "228"
fc["SAR"] = "229"
fc["SAE"] = "230"
fc["SCC"] = "231"
fc["SEG"] = "232"
fc["SEA"] = "233"
fc["SEC"] = "234"
fc["SED"] = "235"
fc["SIG"] = "236"
fc["SIA"] = "237"
fc["SIC"] = "238"
fc["SID"] = "239"
fc["SET"] = "240"
fc["SNT"] = "241"
fc["SOG"] = "242"
fc["SOA"] = "243"
fc["SOC"] = "244"
fc["SOT"] = "245"
fc["SOD"] = "246"
fc["DVS"] = "247"
fc["SOS"] = "248"
fc["SUG"] = "249"
fc["SUA"] = "250"
fc["SUC"] = "251"
fc["SUD"] = "252"
fc["SYA"] = "253"
fc["SLT"] = "254"
fc["SYD"] = "255"
function scan(name, line, wildcards)
	table.insert(data, wildcards[1])
end
function filestart(name, line, wildcards)
	Pause (true)
	fl = wildcards [1]
	nm = wildcards [2]
	ext = wildcards [3]
	pl = wildcards [4]
	EnableTriggerGroup ("filestop", true)
	EnableTriggerGroup ("filestart", false)
	EnableTriggerGroup ("musicstart", false)
	EnableTriggerGroup ("scan", true)
end
function fileend(name, line, wildcards)
	Pause (false)
	EnableTriggerGroup ("musicstart", true)
	EnableTriggerGroup ("filestart", true)
	EnableTriggerGroup ("filestop", false)
	EnableTriggerGroup ("scan", false)
	local file = nil
	if pl == "y" then
		if ext == ".mid" then
			file = io.open("sounds/temp" .. tmp .. ext, "wb")
		elseif ext == ".wav" then
			file = io.open("sounds/temp" .. tmpw .. ext, "wb")
		end
	else
		file = io.open(fl .. nm .. ext, "wb")
	end
	if file ~= nil then
	for i,v in ipairs(data) do
		local d = tofile(v)
		file:write(d)
	end
	file:close(file)
		local msg =("File " .. fl .. nm .. ext .. " Recived ")
		ColourNote("green","black",msg)
	else
		ColourNote("green","black","File " .. fl .. nm .. ext .. " Failed")
		data = {}
		fl = ""
		ext = ""
		nm = ""
		return
	end
	if pl == "y" then
		local fn = ""
		local trig = ""
		if ext == ".mid" then
			fn = ("sounds/temp" .. tmp .. ext)
			trig = ("MIDIMUSICPLAY_temp" .. tmp .. "")
			AddTrigger("musicplay", trig, "", (trigger_flag.Enabled + trigger_flag.OneShot + trigger_flag.OmitFromOutput) , custom_colour.Custom15, 0, fn, "")
			currentlyplaying = nm
			if tmp == 1 then tmp = 2 SendNoEcho("echo MIDIMUSICPLAY_temp1") else tmp = 1 SendNoEcho("echo MIDIMUSICPLAY_temp2") end
			ColourNote("green","black","Now playing: " .. currentlyplaying .. "")
		elseif ext == ".wav" then
			fn = ("temp" .. tmpw .. ext)
			PlaySound (1, fn, false, -3, 0)
			if tmpw ~= 4 then tmpw = tmpw + 1 else tmpw = 1 end
		end
	elseif pl == "pl" then
		ColourNote("green","black","File " .. fl .. nm .. ext .. " can now be (re)installed")
	end
	data = {}
	fl = ""
	ext = ""
	nm = ""
end
function tofile(data)
	local n = "NWL"
	local t = "TAB"
	if pl ~= "pl" then
		for i,v in pairs(fc) do
			data = string.gsub(data, "$" .. i, string.char(v) )
		end
		for i,v in pairs(cc) do
			data = string.gsub(data, "$" .. i, string.char(v))
		end
		data = string.gsub(data, "{/file}", "")
		data = string.gsub(data,"$" .. n, "\n")
	else
		local s = "FND"
		data = string.gsub(data, "{/file}", "")
		data = string.gsub(data,"$" .. s, "{/file}")
		data = string.gsub(data,"$" .. n, "\n")
		data = string.gsub(data,"$" .. t, "\t")
	end
	return data
end
</script>
</muclient>
